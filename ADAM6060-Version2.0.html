<!DOCTYPE html>
<!-- saved from url=(0095)https://advdownload.advantech.com/productfile/Downloadfile1/1-2HG5MO5/ADAM6060-Version1.00.html -->
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
    />
    <title>CPS - LHD</title>
    <script>
      // Definisikan loaderName di awal agar bisa digunakan segera
      var loaderName = "8200"; // Variabel untuk nama loader
      document.title = "CPS - LHD " + loaderName;
    </script>
    <style>
      /* CSS yang dioptimalkan untuk ADAM module */
      :root {
        --primary-color: #1a237e;
        --secondary-color: #0d47a1;
        --warning-color: #ffa500;
        --danger-color: #ff3300;
        --background-color: #f8f9fa;
        --card-bg: #ffffff;
        --success-color: #00c853;
      }

      *,
      ::after,
      ::before {
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f5f5f5;
        color: #333;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }

      h1,
      h2,
      h3,
      h4,
      h5,
      h6 {
        margin-top: 0;
        margin-bottom: 0.5rem;
        font-weight: 500;
        line-height: 1.2;
      }

      p {
        margin-top: 0;
        margin-bottom: 1rem;
      }

      /* Topnav Styles */
      .topnav {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background-color: #0a2351; /* Mengubah kembali ke warna navy yang lebih gelap */
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 20px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        z-index: 1000;
      }

      .topnav-left {
        display: flex;
        align-items: center;
        width: 33%;
      }

      .topnav-center {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 34%;
      }

      .topnav-center h3 {
        margin: 0;
        color: #ffd43b;
        font-size: 1.5rem;
        text-align: center;
        font-weight: bold;
      }

      .topnav-left h3 {
        margin: 0;
        color: #ffd43b;
        font-size: 1.5rem;
      }

      .topnav-right {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        width: 33%;
      }

      .logo-trakindo {
        height: 50px;
        width: auto;
        margin-left: 10px;
      }

      .logo-freeport {
        height: 30px;
        width: auto;
        margin-right: 10px;
      }

      .nav-btn {
        background: none;
        border: none;
        color: #ffd43b;
        font-size: 1.5rem;
        cursor: pointer;
        margin-right: 10px;
      }

      .nav-btn:hover {
        color: #ffffff;
      }

      /* Container Styles */
      .container {
        display: flex;
        flex: 1;
        padding: 20px;
        gap: 20px;
        margin-top: 70px; /* Menambah jarak antara topnav dan container dari 60px menjadi 80px */
        margin-bottom: 60px; /* Memberikan ruang untuk footer fixed */
        max-width: 100%;
        box-sizing: border-box;
      }

      .left-panel {
        display: flex;
        flex-direction: column;
        gap: 10px; /* Mengurangi gap dari 20px menjadi 10px */
        width: 50%; /* Menetapkan lebar panel kiri menjadi 50% */
      }

      .right-panel {
        background: rgb(222, 222, 222);
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        width: 50%; /* Menetapkan lebar panel kanan menjadi 50% */
        box-sizing: border-box;
        margin-bottom: 10px; /* Menambahkan margin-bottom agar tidak terlalu panjang */
        height: fit-content; /* Mengatur tinggi sesuai dengan konten */
      }

      @media (max-width: 992px) {
        .container {
          flex-direction: column;
        }

        .left-panel,
        .right-panel {
          width: 100%;
        }
      }

      .status-card {
        background: white;
        padding: 15px; /* Mengurangi padding dari 20px menjadi 15px */
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 0; /* Menghapus margin-bottom jika ada */
      }

      .status-header {
        font-size: 1.2rem;
        font-weight: bold;
        margin-bottom: 15px;
        color: var(--primary-color);
        background-color: #ffd700;
        padding: 10px;
        border-radius: 5px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      #currentTime {
        font-size: 14px;
        color: #666;
      }

      .status-parking {
        background-color: #ff4500;
        color: white;
        border-radius: 5px;
      }

      .current-time {
        font-size: 0.9rem;
        color: #666;
      }

      .status-grid {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 10px;
        margin-top: 15px;
      }

      .status-item {
        text-align: center;
      }

      .status-light {
        width: 48px;
        height: 48px;
        transition: transform 0.2s;
        display: block;
      }

      .status-light:hover {
        transform: scale(1.1);
      }

      /* Tambahkan CSS untuk loader */
      .loader-container {
        position: relative;
        width: 400px;
        height: 400px;
        margin: 20px auto;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .loader-image {
        width: 250px;
        height: 250px;
        position: relative;
        z-index: 2;
      }

      .indicator-box {
        position: absolute;
        width: 300px;
        height: 300px;
        z-index: 1;
      }

      .indicator-box.rear {
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        -webkit-mask: linear-gradient(
              to right,
              #000 0%,
              #000 20%,
              transparent 20%,
              transparent 80%,
              #000 80%,
              #000 100%
            )
            top/100% 70%,
          linear-gradient(to right, #000 0%, #000 100%) bottom/100% 30%;
        -webkit-mask-repeat: no-repeat;
        mask: linear-gradient(
              to right,
              #000 0%,
              #000 20%,
              transparent 20%,
              transparent 80%,
              #000 80%,
              #000 100%
            )
            top/100% 70%,
          linear-gradient(to right, #000 0%, #000 100%) bottom/100% 30%;
        mask-repeat: no-repeat;
      }

      .indicator-box.rear.on {
        background-color: #ff0000;
        animation: blink 1s infinite;
      }

      .indicator-box.rear.off {
        background-color: #333333;
      }

      /* Container untuk loader dan rear box */
      .main-container {
        position: relative;
        width: 400px;
        height: 500px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }

      /* Pastikan loader berada di atas rear box */
      .loader-icon {
        width: 100%;
        height: 100%;
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        z-index: 2;
      }

      /* CSS untuk parking brake icon */
      .parking-brake-icon {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 40px;
        height: 40px;
      }

      /* CSS untuk efek blinking */
      @keyframes blink {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0;
        }
        100% {
          opacity: 1;
        }
      }

      .blinking {
        animation: blink 0.5s infinite;
      }

      .loader-indicator {
        flex: 0 0 auto;
        display: flex;
        align-items: center;
      }

      .loader-indicator.left {
        margin-right: 10px;
      }

      .loader-indicator.right {
        margin-left: 10px;
      }

      .graph-container {
        background: white;
        padding: 15px; /* Mengurangi padding dari 20px menjadi 15px */
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 0; /* Menghapus margin-bottom */
        overflow-x: auto;
      }

      #logBox {
        width: 100%;
        height: 350px; /* Mengurangi tinggi dari 350px menjadi 300px */
        margin-bottom: 10px;
        font-family: monospace;
        font-size: 18px;
        background-color: #f5f5f5;
        color: #333;
        border: 1px solid #ccc;
        padding: 10px;
        resize: vertical;
      }

      /* Wrapper untuk tombol save dan status terakhir disimpan */
      .log-controls {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 10px;
      }

      .save-info {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
      }

      #lastSaveTime {
        font-size: 14px;
        margin: 0;
        color: #1a237e;
      }

      #noteLogSave,
      #noteAutoSaveTime {
        font-size: 12px;
        color: #666;
        font-style: italic;
        margin: 0;
        color: #1a237e;
      }

      #saveLogBtn:before {
        content: "⬇️";
        margin-right: 2px;
        font-size: 16px;
      }

      #saveLogBtn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 8px 10px;
        background-color: #0d6efd;
        color: white;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-size: 14px;
        align-self: flex-start;
      }

      .polling-info {
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 10px;
      }

      h1,
      h2,
      h3,
      h4,
      h5 {
        margin: 0;
        padding: 0;
      }

      h1 {
        font-size: 1.8rem;
      }

      h4 {
        margin-bottom: 10px;
        color: var(--primary-color);
      }

      h5 {
        color: #333;
        margin-bottom: 10px;
      }

      /* Footer Card Styles */
      .footer-container {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        width: 100%;
        z-index: 1000;
      }

      .footer-copyright {
        text-align: center;
        padding: 10px 0;
        color: #6c757d;
        background-color: #f8f9fa;
        border-top: 1px solid #dee2e6;
        font-size: 14px;
      }

      .footer-copyright p {
        margin: 2px 0;
      }

      /* CSS yang dioptimalkan untuk loader dan indikator */
      .loader-container {
        padding: 20px;
        position: relative;
        min-height: 400px; /* Tinggi minimum yang lebih besar */
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .loader-indicators {
        position: relative;
        width: 100%;
        height: 100%;
      }

      .loader-image {
        width: auto;
        height: auto;
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        background-color: transparent; /* Menambahkan background transparan */
      }

      .loader-icon {
        width: 100px; /* Mengecilkan ukuran loader */
        height: auto;
        display: block;
        margin: 0 auto;
        margin-top: -25px;
        background-color: transparent; /* Menambahkan background transparan */
      }

      .loader-indicator {
        position: absolute;
        text-align: center;
      }

      .loader-indicator h5 {
        margin-bottom: 5px;
        color: #333;
        font-size: 0.9rem;
      }

      .loader-indicator.front {
        left: 50px; /* Geser ke kanan agar lebih dekat dengan loader */
        top: 180px;
      }

      .loader-indicator.rear {
        bottom: -20px; /* Geser lebih ke bawah */
        left: 50%;
        transform: translateX(-50%);
      }

      .status-light {
        width: 40px;
        height: 40px;
        transition: transform 0.2s;
        display: block;
        margin: 0 auto;
      }

      .hidden {
        display: none;
      }

      /* Header loader status warna abu-abu */
      .status-header.loader-header {
        background-color: #ffd700;
      }

      /* Background hitam untuk card loader */
      .status-card.loader-card {
        background-color: #000000;
      }

      /* Warna teks untuk elemen dalam card loader */
      .loader-card .polling-info {
        color: #999;
      }

      .loader-card h5 {
        color: #ffffff;
      }

      /* CSS untuk indikator kotak */
      .indicator-box {
        width: 80px;
        height: 60px;
        position: relative;
        margin: 10px;
      }

      .indicator-box.front,
      .indicator-box.rear {
        -webkit-mask: linear-gradient(
              to right,
              #000 0%,
              #000 20%,
              transparent 20%,
              transparent 80%,
              #000 80%,
              #000 100%
            )
            top/100% 70%,
          linear-gradient(to right, #000 0%, #000 100%) bottom/100% 30%;
        -webkit-mask-repeat: no-repeat;
        mask: linear-gradient(
              to right,
              #000 0%,
              #000 20%,
              transparent 20%,
              transparent 80%,
              #000 80%,
              #000 100%
            )
            top/100% 70%,
          linear-gradient(to right, #000 0%, #000 100%) bottom/100% 30%;
        mask-repeat: no-repeat;
      }

      .indicator-box.on {
        background-color: #ff0000;
        animation: blink 1s infinite;
      }

      .indicator-box.off {
        background-color: #333333;
      }

      /* Tambahkan animasi blink untuk status on */
      @keyframes blink {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }

      .indicator-box.on {
        animation: blink 1s infinite;
      }

      .indicator-box.rear {
        width: 120px;
        height: 60px;
        position: absolute;
        bottom: -20px;
        left: 50%;
        transform: translateX(-50%);
      }

      .indicator-box.on {
        background-color: #ff0000;
      }

      .indicator-box.off {
        background-color: #000000;
      }

      /* Menyembunyikan indikator lampu lama */
      .status-light {
        display: none;
      }

      /* Posisi indikator */
      .loader-indicator.front {
        left: 70px; /* Sesuaikan posisi */
      }
    </style>
  </head>
  <body onload="pageOnInit()">
    <div class="topnav">
      <div class="topnav-left">
        <!-- logo freeport base64 -->
        <img
          src="assets/logo-freeport-indonesia-base64.webp"
          alt="Freeport Logo"
          class="logo-freeport"
        />
      </div>
      <div class="topnav-center">
        <h3>
          ⚠️ICA CPS - LHD
          <script>
            document.write(loaderName);
          </script>
        </h3>
      </div>
      <div class="topnav-right">
        <button id="refreshBtn" class="nav-btn">↻</button>
        <button id="fullscreenBtn" class="nav-btn">⛶</button>
        <!-- logo trakindo base64 -->
        <img
          src="assets/logo-trakindo.webp"
          alt="Trakindo Logo"
          class="logo-trakindo"
        />
      </div>
    </div>

    <div class="container">
      <div class="left-panel">
        <!-- Card loader dengan indikator yang dimodifikasi -->
        <div class="status-card loader-card">
          <div class="status-header loader-header">LOADER STATUS</div>
          <div class="polling-info" id="DIPOLL">Polling 0 times...</div>
          <div class="loader-container">
            <div class="loader-indicators">
              <img
                id="parkingBrakeIcon"
                src="assets/parking brake base64.webp"
                class="parking-brake-icon"
              />
              <div class="loader-indicator front">
                <img id="DI0" src="" alt="0" class="status-light" />
                <img
                  id="DI0_indicator"
                  src=""
                  alt="0"
                  class="status-light hidden"
                />
                <div id="front_box" class="indicator-box front off"></div>
              </div>
              <div class="loader-image">
                <img
                  src="assets/loader only base64.webp"
                  alt="Loader"
                  class="loader-icon"
                />
              </div>
              <div class="loader-indicator rear">
                <h5>REAR Safe Zone</h5>
                <img id="DI2" src="" alt="0" class="status-light" />
                <img
                  id="DI2_indicator"
                  src=""
                  alt="0"
                  class="status-light hidden"
                />
                <div id="rear_box" class="indicator-box rear off"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="status-card">
          <div class="status-header status-parking">
            INTERRUPTION SYSTEM STATUS
          </div>
          <div class="polling-info" id="DOPOLL">Polling 0 times...</div>
          <div class="status-item">
            <img id="DO0" src="" alt="0" class="status-light" />
          </div>
        </div>

        <div class="graph-container">
          <table id="TBL0" style="width: 100%">
            <tr>
              <td>
                <canvas id="adamCanvas"></canvas>
              </td>
            </tr>
          </table>
        </div>
      </div>

      <div class="right-panel">
        <div class="status-header">
          <span>SYSTEM LOG</span>
          <span id="currentTime" class="current-time"></span>
        </div>
        <textarea id="logBox" readonly></textarea>
        <div class="log-controls">
          <div class="save-info">
            <div id="lastSaveTime">
              Terakhir disimpan: Invalid Date (Loaded)
            </div>
            <div id="noteLogSave">
              *Log akan disimpan saat menutup browser/tab
            </div>
            <div id="noteAutoSaveTime">
              *Log akan disimpan otomatis setiap 5 menit
            </div>
          </div>
          <button id="saveLogBtn">SAVE LOG</button>
        </div>
      </div>
    </div>

    <div class="footer-container">
      <div class="footer-copyright">
        <p>Collision Prevention System v2.0</p>
        <p>Copyright &copy; 2025 by Trakindo Technology Dept.</p>
      </div>
    </div>

    <script>
      var canvas;
      var ctx;
      var scanInterval = 1000;
      var diTotal = 3; // Ubah dari 2 menjadi 3 untuk menampilkan DI 0, DI 1, dan DI 2
      var doTotal = 1;
      var padSize = 30;
      var gridSize = 16;
      var columnInc = 0;
      var stepSize = 8;
      var fontSize = 10;
      var lightOnSrc, lightOffSrc;
      var diStatus;
      var doStatus;
      var cntMaxTotal, cntIndex, cntTotal;
      var diDataArray;
      var doDataArray;
      var diPolling, diPollingCount;
      var doPolling, doPollingCount;
      var diFailCount, diWaitCount;
      var doFailCount, doWaitCount;
      var maxWait = 5;
      var maxFail = 3;
      var lastAutoSaveTime = Date.now();

      // Variabel untuk mendeteksi refresh
      var isRefreshing = false;

      // Pendekatan yang lebih sederhana untuk mendeteksi refresh
      // Cek apakah ini adalah refresh
      var lastPageLoadTime = localStorage.getItem("lastPageLoadTime");
      var currentTime = new Date().getTime();

      if (lastPageLoadTime && currentTime - lastPageLoadTime < 3000) {
        // Jika waktu antara load terakhir dan sekarang kurang dari 3 detik, ini adalah refresh
        isRefreshing = true;
        console.log("Detected page refresh");
      }

      // Simpan waktu load saat ini
      localStorage.setItem("lastPageLoadTime", currentTime);

      // Tambahkan flag untuk menandai bahwa halaman sedang dimuat
      localStorage.setItem("pageIsLoading", "true");

      // Setelah halaman selesai dimuat, hapus flag
      window.addEventListener("load", function () {
        localStorage.removeItem("pageIsLoading");
      });

      // Fungsi untuk menyimpan log ke file
      function saveLogToFile(forceDownload = false) {
        var logContent = document.getElementById("logBox").value;
        if (!logContent && !forceDownload) return;

        // Format tanggal dan waktu untuk nama file
        var now = new Date();
        var year = now.getFullYear();
        var month = String(now.getMonth() + 1).padStart(2, "0");
        var day = String(now.getDate()).padStart(2, "0");
        var hours = String(now.getHours()).padStart(2, "0");
        var minutes = String(now.getMinutes()).padStart(2, "0");
        var seconds = String(now.getSeconds()).padStart(2, "0");

        var dateTimeString =
          year +
          "-" +
          month +
          "-" +
          day +
          "-" +
          hours +
          "_" +
          minutes +
          "_" +
          seconds;
        var filename = "cps_log_" + loaderName + "_" + dateTimeString + ".txt";

        // Simpan ke localStorage
        try {
          localStorage.setItem("adam_last_log", logContent);
          localStorage.setItem("adam_last_log_time", dateTimeString);
          document.getElementById("lastSaveTime").innerHTML =
            "Terakhir disimpan: " + now.toLocaleTimeString() + " (Autosaved)";
        } catch (e) {
          console.error("Failed to save to localStorage:", e);
          document.getElementById("lastSaveTime").innerHTML =
            "Error saat menyimpan: " + e.message;
        }

        // Download file jika diminta dan belum ada download yang sedang berlangsung
        if (forceDownload) {
          // Tambahkan flag untuk mencegah multiple download
          if (window.isDownloading) return;
          window.isDownloading = true;

          try {
            var blob = new Blob([logContent], {
              type: "text/plain;charset=utf-8",
            });
            var url = window.URL.createObjectURL(blob);
            var link = document.createElement("a");
            link.href = url;
            link.download = filename;

            // Gunakan setTimeout untuk memastikan download selesai sebelum cleanup
            setTimeout(function () {
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              window.URL.revokeObjectURL(url);
              window.isDownloading = false;

              document.getElementById("lastSaveTime").innerHTML =
                "Terakhir disimpan: " +
                now.toLocaleTimeString() +
                " (Downloaded)";

              // Tampilkan alert setelah download selesai
              setTimeout(function () {
                alert("File log berhasil disimpan!");
              }, 500);
            }, 100);
          } catch (e) {
            console.error("Error saat menyimpan file:", e);
            alert("Error saat menyimpan file: " + e.message);
            window.isDownloading = false;
          }
        }
      }

      function AdamTrend_Init() {
        diStatus = new Array(diTotal);
        doStatus = new Array(doTotal);
        diPollingCount = 0;
        doPollingCount = 0;
        diPolling = 0;
        doPolling = 0;
        diFailCount = 0;
        doFailCount = 0;
        diWaitCount = 0;
        doWaitCount = 0;

        for (var iCh = 0; iCh < diTotal; iCh++) {
          diStatus[iCh] = 0;
          if (document.getElementById("DI" + iCh)) {
            document.getElementById("DI" + iCh).src = lightOffSrc;
          }
        }
        //
        for (var iCh = 0; iCh < doTotal; iCh++) {
          doStatus[iCh] = 0;
          if (document.getElementById("DO" + iCh)) {
            document.getElementById("DO" + iCh).src = lightOffSrc;
          }
        }
        //
        canvas = document.getElementById("adamCanvas");
        try {
          ctx = canvas.getContext("2d");
          canvas.width = document.getElementById("TBL0").offsetWidth;
          // Menghitung tinggi canvas yang sesuai berdasarkan jumlah channel aktif
          var activeChannels = 2; // DI-0 dan DI-2
          var totalChannels = activeChannels + doTotal; // Tambah DO-0
          canvas.height = padSize * 2 + gridSize * totalChannels;

          // deal with data
          cntMaxTotal =
            Math.floor((canvas.clientWidth - padSize * 2) / stepSize) + 1;
          cntTotal = 0;
          cntIndex = 0;
        } catch (e) {
          ctx = null;
          alert(
            "Your browser doesn't support Canvas! The historical data will not be shown!"
          );
        }
      }

      function AdamTrend_DrawLabel() {
        var iCnt, x, y1, y2;

        diDataArray = new Array(diTotal);
        doDataArray = new Array(doTotal);
        ctx.font = fontSize + "px Arial";

        // new data array & draw label
        x = canvas.width - padSize + 1;
        y1 = padSize + (gridSize + fontSize) / 2;

        // Gambar label untuk DI-0 dan DI-2 dengan spacing yang lebih rapi
        var activeChannels = 0;
        for (var iCh = 0; iCh < diTotal; iCh++) {
          diDataArray[iCh] = new Array(cntMaxTotal);
          if (iCh !== 1) {
            // Skip DI-1
            y2 = y1 + gridSize * activeChannels;
            ctx.fillText("DI-" + iCh, 0, y2);
            ctx.fillText("DI-" + iCh, x, y2);
            activeChannels++;
          }
        }

        // Gambar label untuk DO-0 dengan posisi yang sesuai
        y1 = padSize + gridSize * 2 + (gridSize + fontSize) / 2;
        for (var iCh = 0; iCh < doTotal; iCh++) {
          doDataArray[iCh] = new Array(cntMaxTotal);
          y2 = y1;
          ctx.fillText("DO-" + iCh, 0, y2);
          ctx.fillText("DO-" + iCh, x, y2);
        }

        // draw bottom label
        y1 = canvas.clientHeight - padSize;
        y2 = y1 + 10;
        x = canvas.clientWidth - padSize;
        ctx.fillStyle = "#000000";
        ctx.strokeStyle = "#000000";
        ctx.lineWidth = 1;
        iCnt = 0;
        while (x >= padSize) {
          ctx.beginPath();
          ctx.moveTo(x, y1);
          ctx.lineTo(x, y2);
          ctx.stroke();
          if (iCnt < 10) ctx.fillText(iCnt, x - 3, y2 + fontSize + 2);
          else ctx.fillText(iCnt, x - 6, y2 + fontSize + 2);
          iCnt += Math.floor(
            (((gridSize * 2) / stepSize) * scanInterval) / 1000
          );
          x -= gridSize * 2;
        }
      }

      function AdamTrend_UpdateData() {
        if (cntTotal == 0) {
          cntIndex = 0;
          cntTotal = 1;
        } else if (cntTotal < cntMaxTotal) {
          cntTotal++;
          cntIndex++;
        } else {
          if (cntIndex < cntMaxTotal - 1) cntIndex++;
          else cntIndex = 0;
        }
        //
        for (var iCh = 0; iCh < diTotal; iCh++)
          diDataArray[iCh][cntIndex] = diStatus[iCh];
        for (var iCh = 0; iCh < doTotal; iCh++)
          doDataArray[iCh][cntIndex] = doStatus[iCh];
      }

      function AdamTrend_RefreshDataLine(iType, iCh) {
        var iCnt, iIdx, x, yOn, yOff;
        var preX, preVal, val;
        var y = new Array(2);
        if (cntTotal > 1) {
          if (iType == 0) {
            // DI
            // Hitung posisi y berdasarkan channel yang aktif
            var activeChannelIndex = iCh === 0 ? 0 : 1; // DI-0 = index 0, DI-2 = index 1
            y[0] = padSize + gridSize + gridSize * activeChannelIndex; // channel OFF
            y[1] =
              padSize + gridSize + gridSize * activeChannelIndex - gridSize / 2; // channel ON
            ctx.strokeStyle = "#FFA500";
            ctx.fillStyle = "#FFA500";
          } else {
            // DO
            y[0] = padSize + gridSize * 3; // Posisi tetap untuk DO-0
            y[1] = padSize + gridSize * 3 - gridSize / 2;
            ctx.strokeStyle = "#FF3300";
            ctx.fillStyle = "#FF3300";
          }

          iCnt = 0;
          iIdx = cntIndex;
          ctx.lineWidth = 1;
          ctx.beginPath();
          while (iCnt < cntTotal) {
            x = canvas.clientWidth - padSize - stepSize * iCnt - 1;
            if (x < padSize) x = padSize;
            if (iType == 0) val = diDataArray[iCh][iIdx];
            else val = doDataArray[iCh][iIdx];

            if (iCnt == 0) ctx.moveTo(x, y[val]);
            else {
              if (preVal == val) ctx.lineTo(x, y[val]);
              else {
                ctx.lineTo(preX, y[val]);
                ctx.lineTo(x, y[val]);
              }
              if (val == 1) ctx.fillRect(x, y[1], stepSize, gridSize / 2 + 1);
            }

            preX = x;
            preVal = val;
            if (iIdx == 0) iIdx = cntTotal - 1;
            else iIdx--;
            iCnt++;
          }
          ctx.stroke();
        }
      }

      function AdamTrend_RefreshCanvas() {
        // Fill with gradient
        ctx.fillStyle = "#FFFAFA";
        ctx.fillRect(
          padSize,
          padSize,
          canvas.clientWidth - padSize * 2,
          canvas.clientHeight - padSize * 2
        );
        // draw row
        ctx.strokeStyle = "#DCDCDC"; //"#E6E6FA";
        ctx.lineWidth = 1;
        for (
          var y = padSize;
          y < canvas.clientHeight - padSize;
          y += gridSize
        ) {
          ctx.beginPath();
          ctx.moveTo(padSize, y);
          ctx.lineTo(canvas.clientWidth - padSize, y);
          ctx.stroke();
        }
        // draw column
        for (
          var x = canvas.clientWidth - padSize - columnInc;
          x > padSize;
          x -= gridSize
        ) {
          ctx.beginPath();
          ctx.moveTo(x, padSize);
          ctx.lineTo(x, canvas.clientHeight - padSize);
          ctx.stroke();
        }
        columnInc += stepSize;
        if (columnInc >= gridSize) columnInc -= gridSize;
        // draw data line
        for (var iCh = 0; iCh < diTotal; iCh++) {
          // Skip DI-1, hanya tampilkan DI-0 dan DI-2
          if (iCh !== 1) {
            AdamTrend_RefreshDataLine(0, iCh);
          }
        }
        for (var iCh = 0; iCh < doTotal; iCh++)
          AdamTrend_RefreshDataLine(1, iCh);
        // draw border
        ctx.strokeStyle = "#E6E6FA";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(padSize - 1, padSize - 1);
        ctx.lineTo(canvas.clientWidth - padSize + 1, padSize - 1);
        ctx.lineTo(
          canvas.clientWidth - padSize + 1,
          canvas.clientHeight - padSize + 1
        );
        ctx.lineTo(padSize - 1, canvas.clientHeight - padSize + 1);
        ctx.lineTo(padSize - 1, padSize - 1);
        ctx.stroke();
      }

      function pageOnInit() {
        AdamTrend_Init();
        if (ctx != null) AdamTrend_DrawLabel();

        // Update judul halaman dengan nama loader
        document.querySelector(".topnav-center h3").textContent =
          "⚠️ICA CPS - LHD " + loaderName;

        // Cek apakah ada log yang tersimpan di localStorage
        var savedLog = localStorage.getItem("adam_last_log");
        if (savedLog) {
          var logBox = document.getElementById("logBox");
          logBox.value = savedLog + "\n" + logBox.value;

          // Hanya update status terakhir disimpan tanpa download
          var lastSaveTime = localStorage.getItem("adam_last_log_time");
          if (lastSaveTime) {
            document.getElementById("lastSaveTime").innerHTML =
              "Terakhir disimpan: " +
              new Date(lastSaveTime.replace(/-/g, ":")).toLocaleTimeString() +
              " (Loaded)";
          }
        }

        // Mulai timer untuk polling
        pageOnTimer();
      }

      function pageOnTimer() {
        httpGetDiData();
        httpGetDoData();
        if (ctx != null) {
          AdamTrend_UpdateData();
          AdamTrend_RefreshCanvas();
        }
        pageUpdateLights();
        checkAutoSave(); // Cek untuk autosave

        if (diFailCount == maxFail) {
          document.getElementById("BTN0").disabled = true;
          // Hanya simpan ke localStorage tanpa download untuk kasus error
          saveLogToFile(false);
          alert(
            "DI polling has failed " + maxFail + " times, polling suspended!"
          );
        } else if (doFailCount == maxFail) {
          document.getElementById("BTN0").disabled = true;
          // Hanya simpan ke localStorage tanpa download untuk kasus error
          saveLogToFile(false);
          alert(
            "DO polling has failed " + maxFail + " times, polling suspended!"
          );
        } else
          setTimeout(function () {
            pageOnTimer();
          }, scanInterval);
      }

      function updateLogBox(type, channel, value) {
        var logBox = document.getElementById("logBox");
        var now = new Date();
        var year = now.getFullYear();
        var month = String(now.getMonth() + 1).padStart(2, "0");
        var day = String(now.getDate()).padStart(2, "0");
        var timestamp =
          year + "-" + month + "-" + day + " " + now.toLocaleTimeString();
        var message = "";

        // Format pesan berdasarkan tipe dan channel
        if (type === "DI") {
          if (channel === 0) {
            message =
              value == 1
                ? "WARNING Wall Collision FRONT ON"
                : "WARNING Wall Collision FRONT OFF";
          } else if (channel === 2) {
            message =
              value == 1
                ? "WARNING Wall Collision REAR ON"
                : "WARNING Wall Collision REAR OFF";
          }
        } else if (type === "DO" && channel === 0) {
          message =
            value == 1 ? "Parking Brake System ON" : "Parking Brake System OFF";
        }

        var logEntry = timestamp + " - " + message + "\n";
        logBox.value = logEntry + logBox.value;

        // Tambahkan log error jika terjadi masalah koneksi
        if (diFailCount > 0 || doFailCount > 0) {
          var errorEntry =
            timestamp + " - CONNECTION ERROR: Device may be disconnected\n";
          logBox.value = errorEntry + logBox.value;
        }
      }

      function pageUpdateLights() {
        for (var iCh = 0; iCh < diTotal; iCh++) {
          // Hanya proses DI0 dan DI2 (FRONT dan REAR SAFE ZONE)
          if (iCh === 0 || iCh === 2) {
            var diElement = document.getElementById("DI" + iCh);
            var indicatorElement = document.getElementById(
              "DI" + iCh + "_indicator"
            );

            if (diElement && indicatorElement) {
              if (diElement.alt == "0" && diStatus[iCh] == 1) {
                diElement.alt = "1";
                diElement.src = lightOnSrc;
                indicatorElement.alt = "1";
                indicatorElement.src = lightOnSrc;
                updateLogBox("DI", iCh, 1);
              } else if (diElement.alt == "1" && diStatus[iCh] == 0) {
                diElement.alt = "0";
                diElement.src = lightOffSrc;
                indicatorElement.alt = "0";
                indicatorElement.src = lightOffSrc;
                updateLogBox("DI", iCh, 0);
              }
            }
          }
        }

        for (var iCh = 0; iCh < doTotal; iCh++) {
          var doElement = document.getElementById("DO" + iCh);
          if (doElement) {
            if (doElement.alt == "0" && doStatus[iCh] == 1) {
              doElement.alt = "1";
              doElement.src = lightOnSrc;
              updateLogBox("DO", iCh, 1);
            } else if (doElement.alt == "1" && doStatus[iCh] == 0) {
              doElement.alt = "0";
              doElement.src = lightOffSrc;
              updateLogBox("DO", iCh, 0);
            }
          }
        }

        // Tambahkan panggilan ke updateIndicatorBoxes di akhir fungsi
        updateIndicatorBoxes();
      }

      function pageOnCbxClick(iDo) {
        var bAll = true;
        if (iDo == 99) {
          for (var iCh = 0; iCh < doTotal; iCh++)
            document.getElementById("CHK" + iCh).checked =
              document.getElementById("ALL").checked;
        } else {
          for (var iCh = 0; iCh < doTotal; iCh++) {
            if (document.getElementById("CHK" + iCh).checked == false) {
              bAll = false;
              break;
            }
          }
          document.getElementById("ALL").checked = bAll;
        }
      }

      function pageOnApplyClick() {
        var szPostData = "";
        var xmlHttp = null;

        for (var iCh = 0; iCh < doTotal; iCh++) {
          if (document.getElementById("CHK" + iCh).checked)
            szPostData += "DO" + iCh + "=1";
          else szPostData += "DO" + iCh + "=0";
          if (iCh < doTotal - 1) szPostData += "&";
        }
        try {
          if (window.XMLHttpRequest) {
            // code for IE7+, Firefox, Chrome, Opera, Safari
            xmlHttp = new XMLHttpRequest();
          } else {
            // code for IE6, IE5
            xmlHttp = new ActiveXObject("Microsoft.XMLHTTP");
          }
          xmlHttp.onreadystatechange = function () {
            if (xmlHttp.readyState == 4) {
              if (xmlHttp.status == 200) {
                xmlDoc = xmlHttp.responseXML;
                if (xmlDoc.documentElement.attributes[0].nodeValue != "OK")
                  alert(
                    "Set DO failed! " +
                      xmlDoc.documentElement.attributes[0].nodeValue
                  );
              } else alert(" DoOutErr:" + xmlHttp.status + "!");
            }
          };
          xmlHttp.open("POST", "digitaloutput/all/value", true);
          xmlHttp.send(szPostData);
        } catch (e) {
          alert(e);
        }
      }

      function httpGetDiData() {
        var xmlHttp = null;

        try {
          if (diPolling == 0) {
            diWaitCount = 0;
            if (window.XMLHttpRequest) {
              // code for IE7+, Firefox, Chrome, Opera, Safari
              xmlHttp = new XMLHttpRequest();
            } else {
              // code for IE6, IE5
              xmlHttp = new ActiveXObject("Microsoft.XMLHTTP");
            }
            xmlHttp.onreadystatechange = function () {
              var szPoll;
              var xmlDoc;
              var diRecords;
              var iCh;

              if (xmlHttp.readyState == 4) {
                if (xmlHttp.status == 200) {
                  xmlDoc = xmlHttp.responseXML;
                  if (xmlDoc.documentElement.attributes[0].nodeValue == "OK") {
                    diRecords = xmlDoc.getElementsByTagName("DI");
                    if (diRecords != null) {
                      for (var iCnt = 0; iCnt < diRecords.length; iCnt++) {
                        iCh =
                          diRecords[iCnt].getElementsByTagName("ID")[0]
                            .childNodes[0].nodeValue;
                        if (iCh < diTotal)
                          diStatus[iCh] =
                            diRecords[iCnt].getElementsByTagName(
                              "VALUE"
                            )[0].childNodes[0].nodeValue;
                      }
                    } else
                      document.getElementById("DIPOLL").innerHTML +=
                        " DiErr0:DI null!";
                  } else
                    document.getElementById("DIPOLL").innerHTML +=
                      " DiErr1:" +
                      xmlDoc.documentElement.attributes[0].nodeValue +
                      "!";
                } else
                  document.getElementById("DIPOLL").innerHTML +=
                    " DiErr2:" + xmlHttp.status + "!";
                diPolling = 0;
                diFailCount = 0; // reset fail count
              }
            };
            xmlHttp.open("GET", "digitalinput/all/value", true);
            xmlHttp.send();
            diPolling = 1;
            diPollingCount++;
            document.getElementById("DIPOLL").innerHTML =
              "Polling " + diPollingCount + " times...";
          } else {
            diWaitCount++;
            if (diWaitCount == maxWait) {
              diFailCount++;
              if (diFailCount < maxFail) {
                diPolling = 0; // resend
              }
            }
          }
        } catch (e) {
          diPolling = 0;
          document.getElementById("DIPOLL").innerHTML = "DiErr3:" + e + "!";
        }
      }

      function httpGetDoData() {
        var xmlHttp = null;

        try {
          if (doPolling == 0) {
            doWaitCount = 0;
            if (window.XMLHttpRequest) {
              // code for IE7+, Firefox, Chrome, Opera, Safari
              xmlHttp = new XMLHttpRequest();
            } else {
              // code for IE6, IE5
              xmlHttp = new ActiveXObject("Microsoft.XMLHTTP");
            }
            xmlHttp.onreadystatechange = function () {
              var szPoll;
              var xmlDoc;
              var doRecords;
              var iCh;

              if (xmlHttp.readyState == 4) {
                if (xmlHttp.status == 200) {
                  xmlDoc = xmlHttp.responseXML;
                  if (xmlDoc.documentElement.attributes[0].nodeValue == "OK") {
                    doRecords = xmlDoc.getElementsByTagName("DO");
                    if (doRecords != null) {
                      for (var iCnt = 0; iCnt < doRecords.length; iCnt++) {
                        iCh =
                          doRecords[iCnt].getElementsByTagName("ID")[0]
                            .childNodes[0].nodeValue;
                        if (iCh < doTotal)
                          doStatus[iCh] =
                            doRecords[iCnt].getElementsByTagName(
                              "VALUE"
                            )[0].childNodes[0].nodeValue;
                      }
                    } else
                      document.getElementById("DOPOLL").innerHTML +=
                        " DoErr1:DO null!";
                  } else
                    document.getElementById("DOPOLL").innerHTML +=
                      " DoErr1:" +
                      xmlDoc.documentElement.attributes[0].nodeValue +
                      "!";
                } else
                  document.getElementById("DOPOLL").innerHTML +=
                    " DoErr2:" + xmlHttp.status + "!";
                doPolling = 0;
                doFailCount = 0; // reset fail count
              }
            };
            xmlHttp.open("GET", "digitaloutput/all/value", true);
            xmlHttp.send();
            doPolling = 1;
            doPollingCount++;
            document.getElementById("DOPOLL").innerHTML =
              "Polling " + doPollingCount + " times...";
          } else {
            doWaitCount++;
            if (doWaitCount == maxWait) {
              doFailCount++;
              if (doFailCount < maxFail) {
                doPolling = 0; // resend
              }
            }
          }
        } catch (e) {
          doPolling = 0;
          document.getElementById("DOPOLL").innerHTML = "DoErr3:" + e + "!";
        }
      }

      // Fungsi untuk autosave setiap menit
      function checkAutoSave() {
        var currentTime = Date.now();
        if (currentTime - lastAutoSaveTime >= 300000) {
          // 300000 ms = 5 menit
          saveLogToFile(true); // Download file setiap 5 menit
          lastAutoSaveTime = currentTime;
        }
      }

      // Mendeteksi refresh dengan menambahkan event listener untuk keydown
      document.addEventListener("keydown", function (e) {
        // Deteksi F5 atau Ctrl+R
        if (e.key === "F5" || (e.ctrlKey && e.key === "r")) {
          isRefreshing = true;
        }
      });

      // Mendeteksi klik tombol refresh di browser
      window.addEventListener("pageshow", function (e) {
        if (e.persisted) {
          // Halaman dimuat dari cache (back/forward navigation)
          isRefreshing = false;
        }
      });

      // Modifikasi event beforeunload
      window.addEventListener("beforeunload", function (e) {
        var logContent = document.getElementById("logBox").value;

        // Jika ada log dan bukan refresh (close browser/tab)
        if (logContent && !isRefreshing) {
          e.preventDefault();
          e.returnValue = "Apakah Anda ingin menyimpan log sebelum keluar?";
          saveLogToFile(true);
        }
      });

      // Event listener untuk tombol Save Log
      document
        .getElementById("saveLogBtn")
        .addEventListener("click", function () {
          saveLogToFile(true); // Force download saat tombol diklik
        });

      // Pastikan event listener terpasang setelah DOM selesai dimuat
      window.addEventListener("load", function () {
        // Pastikan tombol Save Log memiliki event listener
        document
          .getElementById("saveLogBtn")
          .addEventListener("click", function () {
            saveLogToFile(true); // Force download saat tombol diklik
          });
      });

      // Fungsi untuk mengatur status DO
      function setDOStatus(channel, value) {
        if (channel < doTotal) {
          // Persiapkan data untuk dikirim
          var szPostData = "DO" + channel + "=" + value;

          try {
            var xmlHttp = null;
            if (window.XMLHttpRequest) {
              xmlHttp = new XMLHttpRequest();
            } else {
              xmlHttp = new ActiveXObject("Microsoft.XMLHTTP");
            }

            xmlHttp.onreadystatechange = function () {
              if (xmlHttp.readyState == 4) {
                if (xmlHttp.status == 200) {
                  xmlDoc = xmlHttp.responseXML;
                  if (xmlDoc.documentElement.attributes[0].nodeValue != "OK") {
                    console.log(
                      "Set DO failed! " +
                        xmlDoc.documentElement.attributes[0].nodeValue
                    );
                  } else {
                    // Update status lokal jika berhasil
                    doStatus[channel] = value;
                    document.getElementById("DO" + channel).alt = value;
                    document.getElementById("DO" + channel).src =
                      value == 1 ? lightOnSrc : lightOffSrc;
                  }
                } else {
                  console.log("DoOutErr:" + xmlHttp.status + "!");
                }
              }
            };

            xmlHttp.open("POST", "digitaloutput/" + channel + "/value", true);
            xmlHttp.send(szPostData);
          } catch (e) {
            console.log("Error setting DO status: " + e);
          }
        }
      }

      // Fungsi untuk tombol refresh dan fullscreen
      document
        .getElementById("refreshBtn")
        .addEventListener("click", function () {
          location.reload();
        });

      document
        .getElementById("fullscreenBtn")
        .addEventListener("click", function () {
          if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch((err) => {
              console.log(
                `Error attempting to enable full-screen mode: ${err.message}`
              );
            });
          } else {
            if (document.exitFullscreen) {
              document.exitFullscreen();
            }
          }
        });

      // Tambahkan fungsi untuk update waktu
      function updateCurrentTime() {
        var now = new Date();
        var timeString = now.toLocaleTimeString();
        document.getElementById("currentTime").innerHTML =
          "Waktu saat ini: " + timeString;
      }

      // Panggil fungsi updateCurrentTime setiap detik
      setInterval(updateCurrentTime, 1000);
      updateCurrentTime(); // Panggil sekali saat halaman dimuat

      // Tambahkan fungsi untuk mengupdate kotak indikator
      function updateIndicatorBoxes() {
        // Update front indicator box
        var di0Status = document.getElementById("DI0").alt;
        var frontBox = document.getElementById("front_box");
        if (di0Status == "1") {
          frontBox.className = "indicator-box front on";
        } else {
          frontBox.className = "indicator-box front off";
        }

        // Update rear indicator box
        var di2Status = document.getElementById("DI2").alt;
        var rearBox = document.getElementById("rear_box");
        if (di2Status == "1") {
          rearBox.className = "indicator-box rear on";
        } else {
          rearBox.className = "indicator-box rear off";
        }
      }
    </script>
  </body>
</html>
