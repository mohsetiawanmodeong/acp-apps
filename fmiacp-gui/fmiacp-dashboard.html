<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FMIACP Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            height: 100vh;
            overflow-x: hidden;
            font-size: 14px;
        }
        /* Topnav Styles */
        .topnav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: #0a2351;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            height: 50px;
        }
        .topnav-left {
            display: flex;
            align-items: center;
            width: 33%;
        }
        .topnav-center {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 34%;
        }
        .topnav-center h3 {
            margin: 0;
            color: #ffd43b;
            font-size: 1.3rem;
            text-align: center;
            font-weight: bold;
        }
        .topnav-right {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            width: 33%;
        }
        .logo-trakindo {
            height: 45px;
            width: auto;
            margin-left: 10px;
        }
        .logo-freeport {
            height: 25px;
            width: auto;
            margin-right: 10px;
        }
        .nav-btn {
            background: none;
            border: none;
            color: #ffd43b;
            font-size: 1.3rem;
            cursor: pointer;
            margin-right: 10px;
        }
        .nav-btn:hover {
            color: #ffffff;
        }
        .container {
            max-width: 100%;
            margin: 60px 0 0 0;
            padding: 0;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .tabs {
            display: flex;
            margin-bottom: 10px;
            padding: 0 10px;
        }
        .tab {
            padding: 8px 20px;
            background-color: #3498db;
            color: white;
            cursor: pointer;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
            font-weight: 500;
            font-size: 0.9rem;
        }
        .tab.active {
            background-color: #2980b9;
            font-weight: bold;
        }
        .tab-content {
            display: none;
            padding: 0 10px 10px 10px;
            flex: 1;
            overflow-y: auto;
        }
        .tab-content.active {
            display: block;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 10px;
        }
        .acp-card {
            background-color: white;
            border-radius: 5px;
            padding: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .acp-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .acp-name {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 1rem;
        }
        .status {
            display: flex;
            align-items: center;
        }
        .indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .online {
            background-color: #2ecc71;
        }
        .offline {
            background-color: #e74c3c;
        }
        .warning {
            background-color: #f39c12; 
        }
        .details {
            margin-top: 8px;
            font-size: 0.85em;
            color: #666;
        }
        .data-stats {
            margin-top: 8px;
            font-family: monospace;
            font-size: 0.85em;
            background-color: #f9f9f9;
            padding: 6px;
            border-radius: 3px;
            border-left: 3px solid #ddd;
        }
        .refresh-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            background: white;
            padding: 8px 10px;
            border-radius: 5px;
            margin: 0 10px 10px 10px;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        button:hover {
            background-color: #2980b9;
        }
        .last-update {
            font-size: 0.85em;
            color: #666;
        }
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .loading-content {
            background-color: white;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            animation: spin 1s linear infinite;
            margin: 0 auto 8px auto;
        }
        .note {
            background-color: #fffacd;
            padding: 8px 10px;
            border-radius: 5px;
            margin: 10px 10px 10px 10px;
            border-left: 4px solid #ffd700;
            font-size: 0.9rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .data-info {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
        }
        .data-value {
            font-weight: bold;
        }
        .data-value.good {
            color: #2ecc71;
        }
        .data-value.medium {
            color: #f39c12;
        }
        .data-value.bad {
            color: #e74c3c;
        }
        .update-frequency {
            margin-top: 5px;
            display: flex;
            align-items: center;
            font-size: 0.9rem;
        }
        .update-frequency label {
            margin-right: 8px;
        }
        .actions {
            margin-top: 8px;
            display: flex;
        }
        .actions button {
            margin-right: 4px;
            padding: 4px 8px;
            font-size: 0.8em;
        }
        .dashboard-controls {
            margin: 0 10px 10px 10px;
            background-color: white;
            padding: 12px 15px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .dashboard-controls button {
            background-color: #27ae60;
            padding: 8px 12px;
        }
        .dashboard-controls button:hover {
            background-color: #219651;
        }
        .update-controls {
            text-align: right;
        }
        .update-frequency {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            font-size: 0.9rem;
        }
        .update-frequency label {
            margin-right: 8px;
        }
        .last-update {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
            text-align: right;
        }
        .footer {
            position: static;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #f0f0f0;
            color: #333;
            padding: 15px;
            text-align: center;
            border-top: 1px solid #ddd;
            margin-top: 20px;
        }
        .footer-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .footer-center {
            text-align: center;
        }
        .footer-text {
            margin-top: 5px;
            font-size: 0.85em;
            color: #777;
            font-weight: bold;
        }
        .footer-version {
            font-weight: bold;
            color: #555;
            font-size: 0.85em;
            margin-bottom: 5px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f5f5f5;
            font-weight: bold;
        }
        tbody tr:hover {
            background-color: #f9f9f9;
        }
        .stats-container {
            display: flex;
            margin-bottom: 20px;
            gap: 15px;
        }
        .stat-card {
            flex: 1;
            text-align: center;
            padding: 15px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
        }
        .stat-value.online {
            color: #2ecc71;
        }
        .stat-value.offline {
            color: #e74c3c;
        }
        .stat-value.total {
            color: #3498db;
        }
        .chart-container {
            background-color: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }
        /* Add CSS for login status */
        .status-connected {
            color: #2ecc71 !important;
            font-weight: bold;
        }
        .status-disconnected {
            color: #e74c3c !important;
        }
        #login-status {
            padding: 4px 8px;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        #logout-btn {
            display: none; /* Hidden by default until logged in */
        }
    </style>
</head>
<body>
    <div class="topnav">
        <div class="topnav-left">
            <img 
                src="data:image/webp;base64,UklGRhoFAABXRUJQVlA4WAoAAAAQAAAAxwAAIAAAQUxQSBcAAAABD/Dz/4iIQKRtszmf/POTiP5PgKz7BwBWUDgg3AQAAPAaAJ0BKsgAIQA+kUCbSKWkIqEqs7uwsBIJZQDUXXAOksyLnoB2bf1PwR8JHpeQJzHeg/0L/beU3ej7mMnX908IHYE8p7gHUC7Z+h3+cf6T0m70ygH/G/7H/2v8H+N3x3Z1PpX2Bv5b/autZ6Ev61ndRJmJOWbNwLm7gx4e9nDMwNbepwvPOKVI+sAAN28VSc9Mxicn8wp8QxC8P2DmIilZ3xPglHaGo24Lz3D71PFJjqHRzsBpIJM+zKt6POIqjtmdzmgM7tFlZFlNXz7cjCAvEFpH0LePL4LpGE0sW9wAAP74JIX+J3gP8qtGOyuCdHauaJO44ikrTxNn7qNGr0Ic/kW/id/PvnPxez9FHjNQObL/pXTwUcqd22ZhbfkONkuUYshDCcWxYDf3+oAAq7Te4VDT/fZMl2ydVqkfHr9CVV/Ja1pDlxDybQ0im1Qtw/+kZCe8IRgH4cz/M2wU//KAdGf1qlBw95t/skHuJ2w3scPYFdACR0fhEIY6rDLHbIAnP3G9QCZM4olyIPcbuJIpzLMs22oAgGRUcou8HjuV+bLUe2ltCO7Sp6/q//EI5gM0/zUm4BMDbkZf/vTdfAArxJWGFepacT0kxtXz0PaFB0qkpx9z+WQTF40yTEiGD5faWQsbzdl+ea5PTbBD1y1DWiJwd9faDkRCpe4wXHPz/8cX//kZxDxP+Uh59BOLIN1oNt7Ri/ajxYtg34C+TiVov0v0QAkd+7u1O4qWd/pIOPQkGDZAKIH4X2a7iP6mjgek//AM/+mrbOSDn2dec48yhQIT7gcPb1dtGqe1zgX4R2pyeNzYqY83t1+OV7nQJ+3aTIXRKHer6dXIXC3MiUZcH/6RgEMWPa+Xb24ernUNw8PH800HKpXVAh4gMzT2xZkQU4tWbZ0iLJ7WkHV7juSlXbs7qZv9ehOYzFf9NHHVlnDWPkcWahyWHmGN4IT6qJUcJ0GZUuTrvtRHwNcqfUTy8IV7f62X3QLQvVtRI0ZTP/KJEnBFH8E0pOrqcpYHgTijmgO91Fa/AYOow+1XMRJUnS7zxPoj08N9YPzCV1vd5Qv8ru8nqMFptOsU4/zOz5AoZXicZYDygSxNnOOLBZxQ7X5+XaEKEiq4QXszSxiJ0hruDFtOHRif8nM2xbWIdOQAO9PdZ3PJ1QY4BhjvKSf106T9gwqUpgeKSSxgpGtOxyLIKo3uKoQbi8LANmIIwRVUpZOO/DvIqfn7AY2cSJqhuEMRtWFJZyxmFR6QOJYn8FKpj5p2kynaKylKGM5N6LC4jW/I2i34pJ7C00S4MzUzDy04xDjQL+8614Eraqy3TH/BuWjLE9v0mJ6W8frUC34E7idqINIVKRxWbVOvwKqtqOjQXDO177j9SMyZxESdvUWPc6d0rM8AH/n2w/k4ySVv6MxwYUOPnhOaUl+6FPhRGT1tJgM7c5+7T2ymfBdk7vsZIxuYzpvOF2xc8AGfJ1bYSbYnbcD4LgEfXgB6KOsF5F17NelS+iqXoFSentvrrMpecJJ4cf9bfvRwYP+/tkVVbomIX5CZj67DnGZf3uxYNY9t1uh4l2pULN1pYt1GqmfiL7XbkKvm6k/qIJM7IWSC7Gf/GH02OQf80IS6KZaasq187/GGgGh8dGfIn5Dj4dojyIxAAAAAAAAA" 
                alt="Freeport Logo" 
                class="logo-freeport"
            />
        </div>
        <div class="topnav-center">
            <h3>FMIACP Dashboard</h3>
        </div>
        <div class="topnav-right">
            <button id="logout-btn" class="nav-btn" title="Logout">⏻</button>
            <button id="fullscreen-btn" class="nav-btn">⛶</button>
            <img 
                src="data:image/webp;base64,UklGRjAEAABXRUJQVlA4WAoAAAAQAAAAYwAAMQAAQUxQSCEAAAABFyAQSFLbH2qNiAgHMmmbmpzJKt05dkX0P1nEPke0ZxEAVlA4IOgDAAAwFACdASpkADIAPpFAmUklpCKhJdzNiLASCWYAy9Rgevcj+PJ3KMBtgPMB+yXq8egDeOPQd6WL/BVvroEPOx+dh3wGshc+c94D+zegHbOca0XTz7/TPsFfq/1jDSfy3p4+ussnYbf9/CgOxQDtbNJLplUalwSnSaReoSW0sKsnBqA23c4amTE3UdDnJVfzRMTKsPCjYbrenLwD6KzW29XzI0u6UIuF/orkAAD+/sy+XN7JawCcx/aZIIzXkbUCPY7/8N9I6Hc1YfyArx5/eto0UbNcSb3gCy16i4EdM6I3hS38W/Lo4NwaHA3DvAFnn/T/mONiK/fIO0z8HyTirb/gLcPzhsfC0dfg1/+YnmxLQbxfi8afTikJwkXqk/EHkkz7RuFVC6v8XlKsJfXEbT66/bAnyuwAPYukHjuuCoVIaoSaX4xMQv+6TIGiBSArermlXeJvKH1MvKpnrY/F+B5wvag85h9Nz72xbhMnt2n1aTFlBNGzReDRaKc6UNqNa4wJAyaCA4qY9Z1WpwYh3dVZX37nkhK8Hg/7mE5P4PKYseLxY5e2ccVG+RNoH3X5G+oUGzLJmbyIZJDXeXHZ5QUrYFpEQjK4FS8T3MrI9JAJHOMKb5ZATfvQWJs3RIGdx90ovpEKfDdez16cBaxxMSSLsEikYoTatJOX9H2bNfNuy1LOzlpcM0Qa+hKAfi9Dx5DCwTC2kwPVBlOSdwnYAYrwK7OhYZLhAmjcv1hj1sQQVQHFVyPw0pe7gqdyMCSkzBccVGJcN4vuRpByAmHuoaps7XmlOf/tJhbPsJJU90JKbZxzQ2fAEjGTqYFUnFJ5LWc9tN+Zb5+4iLyYih4weTiAsJi0agqhCpDbz/fGHd4NZytmSmNZ0Rq9dCQi8PsUx57UZw0kHZKMPgoj0A/511rvpX7BPVPKvuKdQlD/Hi9+DVRdQbrvc4axiz8gnfrsyj7WdN1BUKCsfT7nltdsfkzlNj1zhHKfOsUce94GsDSSCvMNx3pPaqtw55JWwQHetncnmFYy+ynjFDhxHTJiXmOmbaAgFB4Q2JdRjQl+WxYxN2uPoMip2vpjGWbNrN4vOLiJbbYADT5Ua/eTITfB62FBvY+mwvSmut+hSiVdItEFSJaLTIT4zzch6/e9adUrmDOjMaOOapy93csJ+MdAoL5++NWpImkA3qigJDJAfFCzyzkb4wC0VneAiQf63qI8X+yHknE/wj93j+bcH0wo6TY2t58L4eVXm5h8NmsRxk66KXI0EP+hLMnNXBnV1/6/rmbC9TKrZWBG95HQcJq+2i1nMDf+7pzYTUBZFEVFnAgpTBe8SVAAAAAA" 
                alt="Trakindo Logo" 
                class="logo-trakindo"
            />
        </div>
    </div>
    
    <div class="container">
        <div class="dashboard-controls">
            <div>
                <button id="download-data-btn">Download Data (.csv)</button>
                <span style="margin-left: 10px; font-size: 0.9em; color: #666;">Download FMIACP data in CSV format</span>
                <div style="margin-top: 8px;">
                    <label style="margin-right: 10px; display: flex; align-items: center;">
                        <input type="checkbox" id="use-mock-data" style="margin-right: 5px;" onclick="toggleMockData(this.checked)">
                        Gunakan Data Simulasi
                    </label>
                </div>
            </div>
            <div class="update-controls">
                <div style="margin-bottom: 6px; display: flex; align-items: center;">
                    <label style="margin-right: 5px;">API URL:</label>
                    <input type="text" id="api-url-input" value="http://localhost:4990" style="width: 200px; margin-right: 5px; padding: 3px;">
                    <button onclick="updateApiUrl()" style="padding: 3px 8px;">Update</button>
                </div>
                <div class="update-frequency">
                    <label>Update interval:</label>
                    <select id="refresh-interval">
                        <option value="5000">5 detik</option>
                        <option value="10000" selected>10 detik</option>
                        <option value="30000">30 detik</option>
                        <option value="60000">1 menit</option>
                    </select>
                </div>
                <div class="last-update">Last update: <span id="last-update-time">-</span></div>
            </div>
        </div>
        
        <div class="tabs">
            <div class="tab active" data-tab="dashboard-tab">Dashboard</div>
            <div class="tab" data-tab="machine-tab">Machine Data</div>
            <div class="tab" data-tab="table-tab">Data Tables</div>
            <div class="tab" data-tab="status-tab">App Status</div>
        </div>
        
        <!-- Dashboard tab content -->
        <div id="dashboard-tab" class="tab-content active">
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-label">Total Machines</div>
                    <div class="stat-value total" id="total-machines">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Active Machines</div>
                    <div class="stat-value online" id="active-machines">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Inactive Machines</div>
                    <div class="stat-value offline" id="inactive-machines">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Data Points</div>
                    <div class="stat-value total" id="total-data-points">0</div>
                </div>
            </div>
            
            <div class="chart-container">
                <h3>Latest Machine Data Overview</h3>
                <div id="latest-data-overview"></div>
            </div>
            
            <div class="grid" id="dashboard-grid">
                <!-- Cards will be dynamically added here -->
            </div>
        </div>
        
        <!-- Machine Data tab content -->
        <div id="machine-tab" class="tab-content">
            <div class="chart-container">
                <h3>Machine Data by Type</h3>
                <div>
                    <label for="machine-filter">Filter Machine: </label>
                    <select id="machine-filter">
                        <option value="all">All Machines</option>
                        <!-- Machine options will be dynamically added -->
                    </select>
                </div>
                <div id="machine-data-list" class="grid">
                    <!-- Machine data cards will be dynamically added here -->
                </div>
            </div>
        </div>
        
        <!-- Table tab content -->
        <div id="table-tab" class="tab-content">
            <div style="background-color: white; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                <h3>FMIACP Data Table</h3>
                <div style="margin-bottom: 10px;">
                    <input type="text" id="table-search" placeholder="Search data..." style="padding: 6px; width: 300px; margin-right: 10px;">
                    <select id="table-filter">
                        <option value="all">All Categories</option>
                        <!-- Category options will be dynamically added -->
                    </select>
                </div>
                <div style="overflow-x: auto;">
                    <table id="fmiacp-data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Machine Name</th>
                                <th>Start Time</th>
                                <th>Category</th>
                                <th>Type</th>
                                <th>Measurement</th>
                                <th>Value</th>
                                <th>Last Update</th>
                            </tr>
                        </thead>
                        <tbody id="fmiacp-table-body">
                            <!-- Table rows will be dynamically added -->
                        </tbody>
                    </table>
                </div>
                <div style="margin-top: 10px; text-align: right;">
                    <button id="prev-page">Previous</button>
                    <span id="page-info">Page 1 of 1</span>
                    <button id="next-page">Next</button>
                </div>
            </div>
        </div>
        
        <!-- App Status tab content -->
        <div id="status-tab" class="tab-content">
            <div style="background-color: white; padding: 15px; border-radius: 5px;">
                <h3>FMIACP App Status</h3>
                <div id="app-status-container">
                    <div class="stats-container">
                        <div class="stat-card">
                            <div class="stat-label">App Name</div>
                            <div class="stat-value" id="app-name">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Version</div>
                            <div class="stat-value" id="app-version">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Database Connection</div>
                            <div class="stat-value" id="db-connection">-</div>
                        </div>
                    </div>
                    
                    <h4>Data Statistics</h4>
                    <table>
                        <tr>
                            <td>Data Store Size:</td>
                            <td id="data-store-size">-</td>
                        </tr>
                        <tr>
                            <td>Data Store Count:</td>
                            <td id="data-store-count">-</td>
                        </tr>
                        <tr>
                            <td>Data Store Fail Count:</td>
                            <td id="data-store-fail-count">-</td>
                        </tr>
                        <tr>
                            <td>Data Input Count:</td>
                            <td id="data-input-count">-</td>
                        </tr>
                        <tr>
                            <td>Data Input Request Count:</td>
                            <td id="data-input-request-count">-</td>
                        </tr>
                        <tr>
                            <td>Data Output Count:</td>
                            <td id="data-output-count">-</td>
                        </tr>
                        <tr>
                            <td>Data Output Request Count:</td>
                            <td id="data-output-request-count">-</td>
                        </tr>
                    </table>
                    
                    <h4>System Usage</h4>
                    <table>
                        <tr>
                            <td>CPU Usage:</td>
                            <td id="cpu-usage">-</td>
                        </tr>
                        <tr>
                            <td>Memory Usage:</td>
                            <td id="memory-usage">-</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div id="loading" class="loading" style="display: none;">
        <div class="loading-content">
            <div class="spinner"></div>
            <p>Loading FMIACP data...</p>
        </div>
    </div>
    
    <!-- Footer Section -->
    <footer class="footer">
        <div class="footer-container">
            <div class="footer-center">
                <span class="footer-version">FMIACP Dashboard v2.0</span>
                <br>
                <span class="footer-text">Copyright © 2025 by Trakindo Technology Dept.</span>
            </div>
        </div>
    </footer>

    <script>
        // Global variables
        let fmiacpData = [];
        let fmiacpCurrentData = [];
        let refreshTimer = null;
        let currentPage = 1;
        const rowsPerPage = 15;
        let useMockData = false; // Set to true to use mock data instead of real API
        let apiBaseUrl = 'http://localhost:4990'; // Global API base URL that can be updated
        
        // Function to make API requests with proper authentication
        function makeApiRequest(url) {
            return new Promise((resolve, reject) => {
                // If using mock data, return mock response
                if (useMockData) {
                    setTimeout(() => {
                        // Generate mock data for testing
                        const { mockData, mockCurrentData } = generateMockData();
                        
                        if (url.includes('getFMIACP')) {
                            resolve(mockData);
                        } else if (url.includes('getFMIACPCurrent')) {
                            resolve(mockCurrentData);
                        } else if (url.includes('getAppStatusFMIACP')) {
                            resolve({
                                Name: "FMIACP Mock Server",
                                Version: "2.0 (Simulator)",
                                DataStoreSize: mockData.length,
                                DataStoreCount: mockData.length,
                                DataStoreFailCount: 0,
                                DataInputCount: 200,
                                DataInputRequestCount: 20,
                                DataOutputCount: 300,
                                DataOutputRequestCount: 30,
                                DatabaseConnection: "Connected",
                                UsageMemory: {
                                    heapTotal: 50 * 1024 * 1024,
                                    heapUsed: 25 * 1024 * 1024
                                },
                                CPU: 15
                            });
                        }
                        
                        // Update login status for mock data
                        updateLoginStatus(true);
                    }, 500);
                    return;
                }
                
                // Make actual API request - Use fetch instead of XMLHttpRequest
                const authString = btoa(`fmiacp:track1nd0`);
                
                fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Basic ${authString}`
                    },
                    // Don't include credentials to avoid CORS issues
                    credentials: 'omit'
                })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else if (response.status === 401) {
                        throw new Error("Authentication failed. Please try again.");
                    } else {
                        throw new Error(`Request failed with status: ${response.status}`);
                    }
                })
                .then(data => {
                    updateLoginStatus(true);
                    resolve(data);
                })
                .catch(error => {
                    console.error("API request error:", error);
                    updateLoginStatus(false);
                    
                    // If we're running from file protocol and got a CORS error
                    if (window.location.protocol === 'file:' && 
                        (error.message.includes('NetworkError') || error.message.includes('Failed to fetch'))) {
                        
                        console.log("CORS issue detected when running from file:// protocol");
                        
                        // Try enabling mock data automatically
                        if (!useMockData) {
                            console.log("Switching to mock data due to CORS error");
                            const mockCheckbox = document.getElementById('use-mock-data');
                            if (mockCheckbox) {
                                mockCheckbox.checked = true;
                            }
                            useMockData = true;
                            
                            // Try generating mock data instead
                            const { mockData, mockCurrentData } = generateMockData();
                            if (url.includes('getFMIACP')) {
                                resolve(mockData);
                            } else if (url.includes('getFMIACPCurrent')) {
                                resolve(mockCurrentData);
                            } else if (url.includes('getAppStatusFMIACP')) {
                                resolve({
                                    Name: "FMIACP Mock Server",
                                    Version: "2.0 (Simulator)",
                                    DataStoreSize: mockData.length,
                                    DataStoreCount: mockData.length,
                                    DataStoreFailCount: 0,
                                    DataInputCount: 200,
                                    DataInputRequestCount: 20,
                                    DataOutputCount: 300,
                                    DataOutputRequestCount: 30,
                                    DatabaseConnection: "Connected",
                                    UsageMemory: {
                                        heapTotal: 50 * 1024 * 1024,
                                        heapUsed: 25 * 1024 * 1024
                                    },
                                    CPU: 15
                                });
                            }
                            return;
                        }
                        
                        reject(new Error("Terjadi masalah CORS saat mengakses API. Solusinya:\n" +
                                       "1. Gunakan opsi 'Gunakan Data Simulasi'\n" +
                                       "2. Jalankan dashboard dari domain yang sama dengan API\n" +
                                       "3. Hosting dashboard di web server"));
                    } else {
                        reject(error);
                    }
                });
            });
        }
        
        // Function to generate mock data for testing
        function generateMockData() {
            const machineNames = ['LHD-001', 'LHD-002', 'LHD-003', 'LHD-004', 'LHD-005'];
            const categories = ['ENGINE', 'HYDRAULIC', 'ELECTRICAL', 'TRANSMISSION'];
            const types = ['TEMPERATURE', 'PRESSURE', 'LEVEL', 'VOLTAGE', 'CURRENT'];
            const measurements = ['CELSIUS', 'PSI', 'PERCENTAGE', 'VOLTS', 'AMPS'];
            
            // Generate random mock data
            const mockData = [];
            const mockCurrentData = [];
            
            // Generate 100 historical records
            for (let i = 1; i <= 100; i++) {
                const machineIndex = Math.floor(Math.random() * machineNames.length);
                const categoryIndex = Math.floor(Math.random() * categories.length);
                const typeIndex = Math.floor(Math.random() * types.length);
                const measurementIndex = Math.floor(Math.random() * measurements.length);
                
                const now = new Date();
                const randomPastTime = new Date(now.getTime() - Math.random() * 30 * 24 * 60 * 60 * 1000); // Random time in the last 30 days
                
                mockData.push({
                    ID: i,
                    MACHINE_NAME: machineNames[machineIndex],
                    START_TIME: randomPastTime.toISOString(),
                    CATEGORY: categories[categoryIndex],
                    TYPE: types[typeIndex],
                    MEASUREMENT: measurements[measurementIndex],
                    VALUE: Math.floor(Math.random() * 100).toString(),
                    LAST_UPDATE: randomPastTime.toISOString()
                });
            }
            
            // Generate current data (most recent entries for each machine-type combo)
            machineNames.forEach(machine => {
                types.forEach(type => {
                    const categoryIndex = Math.floor(Math.random() * categories.length);
                    const measurementIndex = Math.floor(Math.random() * measurements.length);
                    
                    // 80% chance of recent data (active), 20% chance of old data (inactive)
                    const isActive = Math.random() < 0.8;
                    const now = new Date();
                    const lastUpdateTime = isActive 
                        ? new Date(now.getTime() - Math.random() * 30 * 60 * 1000) // Last 30 minutes
                        : new Date(now.getTime() - (24 + Math.random() * 48) * 60 * 60 * 1000); // 1-3 days ago
                    
                    mockCurrentData.push({
                        ID: mockCurrentData.length + 1,
                        MACHINE_NAME: machine,
                        START_TIME: lastUpdateTime.toISOString(),
                        CATEGORY: categories[categoryIndex],
                        TYPE: type,
                        MEASUREMENT: measurements[measurementIndex],
                        VALUE: Math.floor(Math.random() * 100).toString(),
                        LAST_UPDATE: lastUpdateTime.toISOString()
                    });
                });
            });
            
            return { mockData, mockCurrentData };
        }
        
        // Document ready function
        document.addEventListener('DOMContentLoaded', () => {
            // Add login status display to the top navigation
            const topnavRight = document.querySelector('.topnav-right');
            if (!document.querySelector('#login-status')) {
                const statusDiv = document.createElement('div');
                statusDiv.style.display = 'flex';
                statusDiv.style.alignItems = 'center';
                statusDiv.style.marginRight = '15px';
                statusDiv.innerHTML = `
                    <span style="color: white; margin-right: 5px;">API:</span>
                    <span id="login-status" class="status-disconnected" title="Silahkan login untuk mengakses data">Terputus</span>
                `;
                topnavRight.insertBefore(statusDiv, topnavRight.firstChild);
                
                // Update the status with the current port
                updateLoginStatus(false);
            }
            
            // Add logout button to the top navigation
            const logoutBtn = document.querySelector('#logout-btn') || document.createElement('button');
            if (!document.querySelector('#logout-btn')) {
            logoutBtn.className = 'nav-btn';
                logoutBtn.id = 'logout-btn';
            logoutBtn.innerHTML = '⏻'; // Logout icon
            logoutBtn.title = 'Logout';
            logoutBtn.style.marginRight = '10px';
                logoutBtn.style.display = 'none'; // Hidden by default until logged in
            
            logoutBtn.addEventListener('click', () => {
                    alert('Berhasil logout. Silahkan login kembali untuk mengakses data.');
                    // Trigger login on next request
                    fetchData();
            });
            
            topnavRight.insertBefore(logoutBtn, topnavRight.firstChild);
            }
            
            // Set up tab navigation
            setupTabs();
            
            // Set up refresh interval change
            document.getElementById('refresh-interval').addEventListener('change', startAutoRefresh);
            
            // Set up fullscreen button
            document.getElementById('fullscreen-btn').addEventListener('click', toggleFullScreen);
            
            // Set up download button
            document.getElementById('download-data-btn').addEventListener('click', downloadData);
            
            // Table pagination controls
            document.getElementById('prev-page').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderDataTable();
                }
            });
            
            document.getElementById('next-page').addEventListener('click', () => {
                const maxPages = Math.ceil(fmiacpData.length / rowsPerPage);
                if (currentPage < maxPages) {
                    currentPage++;
                    renderDataTable();
                }
            });
            
            // Set up search functionality
            document.getElementById('table-search').addEventListener('input', renderDataTable);
            document.getElementById('table-filter').addEventListener('change', renderDataTable);
            
            // Initial data fetch
            fetchData();
            
            // Start auto refresh
            startAutoRefresh();
        });
        
        // Function to set up tabs
        function setupTabs() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs and contents
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // Add active class to clicked tab and corresponding content
                    tab.classList.add('active');
                    const tabId = tab.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                });
            });
        }
        
        // Replace your fetchData function with this one:
        async function fetchData() {
            showLoading(true);
            
            try {
                if (useMockData) {
                    // Use mock data
                    console.log('Using mock data instead of API');
                    const { mockData, mockCurrentData } = generateMockData();
                    fmiacpData = mockData;
                    fmiacpCurrentData = mockCurrentData;
                    
                    // Mock app status
                    const appStatus = {
                        Name: "FMIACP (Mock)",
                        Version: "2.0",
                        DataStoreSize: mockData.length,
                        DataStoreCount: mockData.length,
                        DataStoreFailCount: 0,
                        DataInputCount: mockData.length,
                        DataInputRequestCount: 10,
                        DataOutputCount: mockData.length * 2,
                        DataOutputRequestCount: 25,
                        DatabaseConnection: "Connected",
                        UsageMemory: {
                            heapTotal: 50 * 1024 * 1024,
                            heapUsed: 30 * 1024 * 1024
                        },
                        CPU: 5
                    };
                    
                    // Update login status for mock mode
                    updateLoginStatus(true);
                    
                    // Update UI
                    updateDashboard();
                    renderMachineData();
                    renderDataTable();
                    updateAppStatus(appStatus);
                    
                    // Update last update time
                    document.getElementById('last-update-time').textContent = new Date().toLocaleString();
                    showLoading(false);
                    return;
                }
                
                console.log(`Fetching data from API: ${apiBaseUrl}`);
                
                try {
                    // Make requests with error handling
                        const [dataAll, dataCurrent, appStatus] = await Promise.all([
                            makeApiRequest(`${apiBaseUrl}/api/getFMIACP`),
                            makeApiRequest(`${apiBaseUrl}/api/getFMIACPCurrent`),
                            makeApiRequest(`${apiBaseUrl}/api/getAppStatusFMIACP`)
                        ]);
                        
                        // Update data & UI
                        fmiacpData = dataAll;
                        fmiacpCurrentData = dataCurrent;
                        
                        updateDashboard();
                        renderMachineData();
                        renderDataTable();
                        updateAppStatus(appStatus);
                        
                        document.getElementById('last-update-time').textContent = new Date().toLocaleString();
                    } catch (err) {
                    console.error('Error fetching data:', err);
                    displayError(err);
                    // Try with mock data if API fails
                    if (!useMockData) {
                        console.log('Switching to mock data due to API error');
                        useMockData = true;
                        // Update checkbox if it exists
                        const mockDataCheckbox = document.getElementById('use-mock-data');
                        if (mockDataCheckbox) {
                            mockDataCheckbox.checked = true;
                        }
                        fetchData(); // Retry with mock data
                    }
                }
            } catch (error) {
                console.error('Unexpected error:', error);
                displayError(error);
            } finally {
                showLoading(false);
            }
        }
        
        // Helper function to display errors
        function displayError(error) {
            console.error('Error fetching data:', error);
            const dashboardGrid = document.getElementById('dashboard-grid');
            dashboardGrid.innerHTML = `
                <div style="background-color: #ffebee; padding: 15px; border-radius: 5px; border-left: 4px solid #e57373;">
                    <h4>Error Connecting to API</h4>
                    <p>${error.message}</p>
                    <p>Please make sure the FMIACP API server is running and accessible.</p>
                    <p><strong>Alternative Solutions:</strong></p>
                    <ul>
                        <li>Check "Use mock data" above to test the dashboard without a real API</li>
                        <li>Make sure your API server is running at ${apiBaseUrl}</li>
                    </ul>
                </div>
            `;
        }
        
        // Function to update dashboard
        function updateDashboard() {
            // Get unique machines
            const machines = [...new Set(fmiacpCurrentData.map(item => item.MACHINE_NAME))];
            
            // Count active and inactive machines
            const activeMachines = machines.filter(machine => {
                const machineData = fmiacpCurrentData.find(item => item.MACHINE_NAME === machine);
                return machineData && new Date(machineData.LAST_UPDATE) > new Date(Date.now() - 3600000); // Active if updated in the last hour
            }).length;
            
            // Update stats
            document.getElementById('total-machines').textContent = machines.length;
            document.getElementById('active-machines').textContent = activeMachines;
            document.getElementById('inactive-machines').textContent = machines.length - activeMachines;
            document.getElementById('total-data-points').textContent = fmiacpData.length;
            
            // Render dashboard grid with current data
            const dashboardGrid = document.getElementById('dashboard-grid');
            dashboardGrid.innerHTML = '';
            
            const latestDataOverview = document.getElementById('latest-data-overview');
            latestDataOverview.innerHTML = `
                <p><strong>Total Machines:</strong> ${machines.length}</p>
                <p><strong>Active Categories:</strong> ${[...new Set(fmiacpCurrentData.map(item => item.CATEGORY))].length}</p>
                <p><strong>Data Types:</strong> ${[...new Set(fmiacpCurrentData.map(item => item.TYPE))].length}</p>
            `;
            
            // Show latest data per machine
            machines.forEach(machine => {
                const machineData = fmiacpCurrentData.filter(item => item.MACHINE_NAME === machine);
                
                const card = document.createElement('div');
                card.className = 'acp-card';
                
                // Determine machine status
                const lastUpdate = new Date(Math.max(...machineData.map(item => new Date(item.LAST_UPDATE))));
                const isActive = lastUpdate > new Date(Date.now() - 3600000); // Active if updated in the last hour
                
                card.innerHTML = `
                    <div class="acp-name">${machine}</div>
                    <div class="status">
                        <div class="indicator ${isActive ? 'online' : 'offline'}"></div>
                        <span>${isActive ? 'Active' : 'Inactive'}</span>
                    </div>
                    <div class="details">Last update: ${lastUpdate.toLocaleString()}</div>
                    <div class="data-stats">
                        Data points: ${machineData.length}
                    </div>
                `;
                
                dashboardGrid.appendChild(card);
            });
        }
        
        // Function to render machine data
        function renderMachineData() {
            const machineDataList = document.getElementById('machine-data-list');
            machineDataList.innerHTML = '';
            
            // If no data is available, show a message
            if (!fmiacpCurrentData || fmiacpCurrentData.length === 0) {
                machineDataList.innerHTML = `
                    <div style="grid-column: 1/-1; background-color: #e3f2fd; padding: 15px; border-radius: 5px; border-left: 4px solid #2196f3;">
                        <h4>No Machine Data Available</h4>
                        <p>No machine data is currently available.</p>
                        <p>You can use the mock data option for testing if the API is not accessible.</p>
                    </div>
                `;
                return;
            }
            
            // Get unique machines for filter dropdown
            const machines = [...new Set(fmiacpCurrentData.map(item => item.MACHINE_NAME))];
            const machineFilter = document.getElementById('machine-filter');
            
            // Clear previous options except the first one
            while (machineFilter.options.length > 1) {
                machineFilter.remove(1);
            }
            
            // Add machine options
            machines.forEach(machine => {
                const option = document.createElement('option');
                option.value = machine;
                option.textContent = machine;
                machineFilter.appendChild(option);
            });
            
            // Filter based on selection
            machineFilter.addEventListener('change', () => {
                renderMachineData();
            });
            
            const selectedMachine = machineFilter.value;
            let filteredData = fmiacpCurrentData;
            
            if (selectedMachine !== 'all') {
                filteredData = fmiacpCurrentData.filter(item => item.MACHINE_NAME === selectedMachine);
            }
            
            // Group by machine and type
            const groupedData = {};
            filteredData.forEach(item => {
                const key = `${item.MACHINE_NAME}-${item.TYPE}`;
                if (!groupedData[key]) {
                    groupedData[key] = [];
                }
                groupedData[key].push(item);
            });
            
            // If no filtered data, show a message
            if (Object.keys(groupedData).length === 0) {
                machineDataList.innerHTML = `
                    <div style="grid-column: 1/-1; background-color: #fff8e1; padding: 15px; border-radius: 5px; border-left: 4px solid #ffc107;">
                        <h4>No Data Found</h4>
                        <p>No machine data matching the selected filter criteria.</p>
                    </div>
                `;
                return;
            }
            
            // Create cards for each machine-type combo
            Object.keys(groupedData).forEach(key => {
                const items = groupedData[key];
                const firstItem = items[0];
                
                const card = document.createElement('div');
                card.className = 'acp-card';
                
                const lastUpdate = new Date(firstItem.LAST_UPDATE);
                const isRecent = lastUpdate > new Date(Date.now() - 3600000); // Updated in the last hour
                
                card.innerHTML = `
                    <div class="acp-name">${firstItem.MACHINE_NAME} - ${firstItem.TYPE}</div>
                    <div class="status">
                        <div class="indicator ${isRecent ? 'online' : 'offline'}"></div>
                        <span>${isRecent ? 'Recent Data' : 'Outdated'}</span>
                    </div>
                    <div class="details">Category: ${firstItem.CATEGORY}</div>
                    <div class="details">Measurement: ${firstItem.MEASUREMENT}</div>
                    <div class="details">Value: ${firstItem.VALUE}</div>
                    <div class="details">Last update: ${lastUpdate.toLocaleString()}</div>
                `;
                
                machineDataList.appendChild(card);
            });
        }
        
        // Function to render data table
        function renderDataTable() {
            const tableBody = document.getElementById('fmiacp-table-body');
            tableBody.innerHTML = '';
            
            // If no data is available, show a message
            if (!fmiacpData || fmiacpData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 20px;">
                            <div style="background-color: #e3f2fd; padding: 15px; border-radius: 5px; border-left: 4px solid #2196f3; display: inline-block; text-align: left;">
                                <h4>No Data Available</h4>
                                <p>No FMIACP data is currently available.</p>
                                <p>You can use the mock data option for testing if the API is not accessible.</p>
                            </div>
                        </td>
                    </tr>
                `;
                
                // Update page info
                document.getElementById('page-info').textContent = 'Page 0 of 0';
                
                // Disable pagination buttons
                document.getElementById('prev-page').disabled = true;
                document.getElementById('next-page').disabled = true;
                
                return;
            }
            
            // Get filter and search values
            const filterValue = document.getElementById('table-filter').value;
            const searchValue = document.getElementById('table-search').value.toLowerCase();
            
            // Update category filter dropdown if needed
            const categoryFilter = document.getElementById('table-filter');
            if (categoryFilter.options.length <= 1) {
                const categories = [...new Set(fmiacpData.map(item => item.CATEGORY))];
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categoryFilter.appendChild(option);
                });
            }
            
            // Filter data
            let filteredData = [...fmiacpData];
            
            if (filterValue !== 'all') {
                filteredData = filteredData.filter(item => item.CATEGORY === filterValue);
            }
            
            if (searchValue) {
                filteredData = filteredData.filter(item => 
                    (item.MACHINE_NAME && item.MACHINE_NAME.toLowerCase().includes(searchValue)) ||
                    (item.CATEGORY && item.CATEGORY.toLowerCase().includes(searchValue)) ||
                    (item.TYPE && item.TYPE.toLowerCase().includes(searchValue)) ||
                    (item.MEASUREMENT && item.MEASUREMENT.toLowerCase().includes(searchValue)) ||
                    (item.VALUE && item.VALUE.toLowerCase().includes(searchValue))
                );
            }
            
            // If no filtered data, show a message
            if (filteredData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 20px;">
                            <div style="background-color: #fff8e1; padding: 15px; border-radius: 5px; border-left: 4px solid #ffc107; display: inline-block; text-align: left;">
                                <h4>No Matching Data</h4>
                                <p>No data matches your search or filter criteria.</p>
                                <p>Try changing your search terms or clearing filters.</p>
                            </div>
                        </td>
                    </tr>
                `;
                
                // Update page info
                document.getElementById('page-info').textContent = 'Page 0 of 0';
                
                // Disable pagination buttons
                document.getElementById('prev-page').disabled = true;
                document.getElementById('next-page').disabled = true;
                
                return;
            }
            
            // Sort by ID descending (newest first)
            filteredData.sort((a, b) => b.ID - a.ID);
            
            // Pagination
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = startIndex + rowsPerPage;
            const pagedData = filteredData.slice(startIndex, endIndex);
            
            // Update page info
            const totalPages = Math.ceil(filteredData.length / rowsPerPage);
            document.getElementById('page-info').textContent = `Page ${currentPage} of ${totalPages || 1}`;
            
            // Disable/enable pagination buttons
            document.getElementById('prev-page').disabled = currentPage === 1;
            document.getElementById('next-page').disabled = currentPage >= totalPages;
            
            // Render table rows
            pagedData.forEach(item => {
                const row = document.createElement('tr');
                
                const startTime = item.START_TIME ? new Date(item.START_TIME).toLocaleString() : '-';
                const lastUpdate = item.LAST_UPDATE ? new Date(item.LAST_UPDATE).toLocaleString() : '-';
                
                row.innerHTML = `
                    <td>${item.ID}</td>
                    <td>${item.MACHINE_NAME || '-'}</td>
                    <td>${startTime}</td>
                    <td>${item.CATEGORY || '-'}</td>
                    <td>${item.TYPE || '-'}</td>
                    <td>${item.MEASUREMENT || '-'}</td>
                    <td>${item.VALUE || '-'}</td>
                    <td>${lastUpdate}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // Function to update app status
        function updateAppStatus(status) {
            // Update basic app info
            document.getElementById('app-name').textContent = status.Name || '-';
            document.getElementById('app-version').textContent = status.Version || '-';
            document.getElementById('db-connection').textContent = status.DatabaseConnection || '-';
            document.getElementById('db-connection').className = 
                status.DatabaseConnection === 'Connected' ? 'data-value good' : 'data-value bad';
            
            // Update data statistics
            document.getElementById('data-store-size').textContent = status.DataStoreSize || 0;
            document.getElementById('data-store-count').textContent = status.DataStoreCount || 0;
            document.getElementById('data-store-fail-count').textContent = status.DataStoreFailCount || 0;
            document.getElementById('data-input-count').textContent = status.DataInputCount || 0;
            document.getElementById('data-input-request-count').textContent = status.DataInputRequestCount || 0;
            document.getElementById('data-output-count').textContent = status.DataOutputCount || 0;
            document.getElementById('data-output-request-count').textContent = status.DataOutputRequestCount || 0;
            
            // Update system usage
            document.getElementById('cpu-usage').textContent = `${status.CPU || 0}%`;
            
            if (status.UsageMemory) {
                const heapTotal = (status.UsageMemory.heapTotal / (1024 * 1024)).toFixed(2);
                const heapUsed = (status.UsageMemory.heapUsed / (1024 * 1024)).toFixed(2);
                document.getElementById('memory-usage').textContent = `Heap: ${heapUsed} MB / ${heapTotal} MB`;
            }
        }
        
        // Function to start or reset auto-refresh timer
        function startAutoRefresh() {
            // Clear existing timer if any
            stopAutoRefresh();
            
            // Get selected interval
            const interval = parseInt(document.getElementById('refresh-interval').value);
            
            // Start new timer
            refreshTimer = setInterval(fetchData, interval);
            
            console.log(`Auto-refresh enabled: ${interval}ms interval`);
        }
        
        // Function to stop auto-refresh
        function stopAutoRefresh() {
            if (refreshTimer) {
                clearInterval(refreshTimer);
                refreshTimer = null;
                console.log('Auto-refresh stopped');
            }
        }
        
        // Function to toggle fullscreen
        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.error(`Error attempting to enable fullscreen: ${err.message}`);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }
        
        // Function to download data as CSV
        function downloadData() {
            if (fmiacpData.length === 0) {
                alert('No data available to download');
                return;
            }
            
            // Create CSV content
            const headers = ['ID', 'MACHINE_NAME', 'START_TIME', 'CATEGORY', 'TYPE', 'MEASUREMENT', 'VALUE', 'LAST_UPDATE'];
            
            let csvContent = headers.join(',') + '\n';
            
            fmiacpData.forEach(item => {
                const startTime = item.START_TIME ? new Date(item.START_TIME).toISOString() : '';
                const lastUpdate = item.LAST_UPDATE ? new Date(item.LAST_UPDATE).toISOString() : '';
                
                const row = [
                    item.ID,
                    `"${item.MACHINE_NAME || ''}"`,
                    `"${startTime}"`,
                    `"${item.CATEGORY || ''}"`,
                    `"${item.TYPE || ''}"`,
                    `"${item.MEASUREMENT || ''}"`,
                    `"${item.VALUE || ''}"`,
                    `"${lastUpdate}"`                ];
                
                csvContent += row.join(',') + '\n';
            });
            
            // Create and download the file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fmiacp_data_${new Date().toISOString().replace(/[:.]/g, '-')}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Function to show/hide loading overlay
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'flex' : 'none';
        }

        // Add the missing updateLoginStatus function
        function updateLoginStatus(isLoggedIn) {
            const statusElement = document.getElementById('login-status');
            
            if (statusElement) {
                // Extract port from API URL
                const portMatch = apiBaseUrl.match(/:(\d+)/);
                const port = portMatch ? portMatch[1] : '?';
                
                // Update status text
                statusElement.textContent = isLoggedIn ? 
                    `Tersambung (Port: ${port})` : 
                    `Terputus (Port: ${port})`;
                    
                // Update class for styling
                statusElement.className = isLoggedIn ? 
                    'status-connected' : 
                    'status-disconnected';
                    
                // Update tooltip
                statusElement.title = isLoggedIn ? 
                    `Terhubung ke API pada ${apiBaseUrl}` : 
                    "Silahkan login untuk mengakses data";
                    
                // Update logout button visibility
                const logoutBtn = document.getElementById('logout-btn');
                if (logoutBtn) {
                    logoutBtn.style.display = isLoggedIn ? 'inline-block' : 'none';
                }
            }
        }

        // Function to toggle mock data
        function toggleMockData(enabled) {
            useMockData = enabled;
            console.log(`Mock data ${enabled ? 'enabled' : 'disabled'}`);
            fetchData(); // Refresh data with new setting
        }

        // Function to update API URL
        function updateApiUrl() {
            const newUrl = document.getElementById('api-url-input').value;
            if (newUrl) {
                apiBaseUrl = newUrl;
                console.log(`API URL updated to: ${apiBaseUrl}`);
                fetchData(); // Refresh data with new URL
            }
        }

        // Function to attempt connection to a specific port
        async function attemptConnection(port) {
            try {
                const tempUrl = `http://localhost:${port}`;
                notification.innerHTML = `Mencoba koneksi ke port ${port}...`;
                
                // Create a promise that will resolve when we get a response
                return new Promise((resolve) => {
                    // Use fetch with no-cors mode to check if server exists
                    // We can't read the response in no-cors mode, but we can detect if the server exists
                    fetch(`${tempUrl}/api/getAppStatusFMIACP`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Basic ${btoa('fmiacp:track1nd0')}`
                        },
                        mode: 'no-cors',  // This prevents CORS errors
                        credentials: 'omit'  // Don't send cookies
                    })
                    .then(() => {
                        // If fetch succeeds in no-cors mode, server exists
                        resolve(true);
                    })
                    .catch(() => {
                        // If fetch fails, try an alternative method
                        const img = new Image();
                        img.onload = function() {
                            // If image loads, server likely exists
                            resolve(true);
                        };
                        img.onerror = function() {
                            // Server might exist but doesn't serve images
                            resolve(false);
                        };
                        // Try to load a favicon or other common file to see if server responds
                        img.src = `${tempUrl}/favicon.ico?${new Date().getTime()}`;
                        
                        // Set a timeout to resolve false if image loading takes too long
                        setTimeout(() => {
                            resolve(false);
                        }, 2000);
                    });
                });
            } catch (error) {
                console.error("Error checking port:", error);
                return false;
            }
        }

        // Function to try next port in sequence
        async function tryNextPort() {
            // List of common ports to try
            const commonPorts = [4990, 50790, 8080, 3000, 5000];
            let currentPortIndex = 0;
            
            // Display notification to user
            const notification = document.createElement('div');
            notification.style.position = 'fixed';
            notification.style.bottom = '20px';
            notification.style.right = '20px';
            notification.style.padding = '12px 20px';
            notification.style.backgroundColor = '#3498db';
            notification.style.color = 'white';
            notification.style.borderRadius = '4px';
            notification.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
            notification.style.zIndex = '9999';
            notification.style.maxWidth = '350px';
            notification.style.transition = 'opacity 0.5s ease-in-out';
            notification.innerHTML = 'Mencari port server API...';
            document.body.appendChild(notification);
            
            // Try ports sequentially
            for (const port of commonPorts) {
                const success = await attemptConnection(port);
                if (success) {
                    // Update API URL with successful port
                    apiBaseUrl = `http://localhost:${port}`;
                    document.getElementById('api-url-input').value = apiBaseUrl;
                    
                    // Update notification
                    notification.style.backgroundColor = '#2ecc71';
                    notification.innerHTML = `Terhubung ke server API pada port ${port}`;
                    setTimeout(() => {
                        notification.style.opacity = '0';
                        setTimeout(() => {
                            document.body.removeChild(notification);
                        }, 500);
                    }, 3000);
                    
                    // Try to fetch data with new URL
                    try {
                        await fetchData();
                        return true;
                    } catch (error) {
                        console.error("Error fetching data after port detection:", error);
                        // Continue trying other ports if data fetch fails
                    }
                }
            }
            
            // If all ports failed
            notification.style.backgroundColor = '#e74c3c';
            notification.innerHTML = 'Tidak dapat menemukan server API pada port manapun. Menggunakan data simulasi.';
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 500);
            }, 5000);
            
            // Switch to mock data if all ports fail
            useMockData = true;
            const mockCheckbox = document.getElementById('use-mock-data');
            if (mockCheckbox) {
                mockCheckbox.checked = true;
            }
            fetchData();
            
            return false;
        }
    </script>
</body>
</html>
